#!/bin/bash
#  vim: foldlevel=0:

# initililize fasd
if which fasd > /dev/null ; then
  eval "$(fasd --init auto)"
  _fasd_bash_hook_cmd_complete v m j o
fi
[ -f ~/.fzf.bash ] && source ~/.fzf.bash

# git aliases

alias ga='git add'
alias gb='git branch'
alias gcam='git commit -am'
alias gcm='git commit -m'
alias gco='git checkout'
alias gcp='git cherry-pick'
alias gd='git difftool --dir-diff'
alias gdf='git diff'
alias gf='git fetch --all'
alias gl="clear; git log --pretty=format:'%C(yellow)%h%C(auto)%d %C(blue)%ae%Creset %s %Cgreen(%cr)' --graph -5"
alias glds="git log -p --all -G" #git log diff search: search in diffs added and removed
alias gp='git push origin HEAD'
alias gpl='git pull --rebase' # git pull --rebase origin master
alias grhh='git reset HEAD --hard'
alias gs='git status -sb'
alias gsp='git stash pop'
alias gst='git stash'
alias gsu='git submodule update --init --recursive'

# other aliases

alias ls='ls --group-directories-first --color'
alias ll='ls -l'
alias la='ls -la'
if [[ -s "$HOME/.dir_colors" ]]; then
  eval "$(dircolors --sh "$HOME/.dir_colors")"
else
  eval "$(dircolors --sh)"
fi
alias grep="grep --color"
alias c='noglob c'
alias feh='feh -r --info "exiv2 %f" --auto-zoom --geometry 1280x960+320+60 -C /usr/share/fonts/TTF -e Ubuntu-R/35'
alias ft='find . -ipath "*.git" -prune -o -print| sed -e "s/[^-][^\/]*\//  |/g"'         # no git file tree  --more fileterd
alias j='fasd_cd -d'
alias l='ls -1Fh'       # classify , human readable, use ll for long
alias n='ncmpcpp'
alias pro='sudo pacman -Rns $(pacman -Qtdq)'  # pac remove orphans
alias r='ranger'
alias ync='yaourt --noconfirm'
alias y='yaourt'
alias sor="status-of-repos"

# FUNCTIONS {{{

ms() { # mpc search
  #mpc search
  # eg ms year:2000 path::Hindi
  # eg ms year:..1995 path::Hindi
  # mpc search filename "`echo $*| sed 's/ /_/g'`"

  beet ls -f '$path' "$@" | sed 's#/home/murali/Dropbox/Songs/##'
}

mp() { #mpc play
  mpc clear
  # mpc search filename "`echo $*| sed 's/ /_/g'`" | mpc add
  beet ls -f '$path' "$@" | sed 's#/home/murali/Dropbox/Songs/##' | mpc add
  mpc play
  # TODO
  # find -type f -iname "*.mp3" -printf "\n%C@ %p" | sort -n | awk '{print $2}' | sed 's#./##' | sed '/^$/d' | mpc add 
}

# database update
mu() {
  rm ~/Dropbox/Songs/musiclibrary.blb; beet import -A ~/Dropbox/Songs/ ;
}

apt-list-packages() {
  dpkg-query -W --showformat='${Installed-Size} ${Package} ${Status}\n' | grep -v deinstall | sort -n | awk '{print $1" "$2}'
}

# time till
tt() {

  if [ $# -eq 0 ];
  then
    echo usage : tt tomorrow5am
    echo usage : tt tomorrow5am -s
    echo usage : sleep $(tt 2:37am -c)
    return 1;
  fi

  seconds=$(( $(date -d "$1" +'%s') - $(date +'%s') ))
  minutes=$(( seconds/60 ))
  hours=$(( minutes/60 ))
  days=$(( hours/24 ))

  if [[ $2 = "-c" ]]; then
    # for piping to sleep
    echo "$seconds"
  elif [[ $2 = "-s" ]]; then
    echo "$days days $(($hours%24)):$(($minutes%60)):$(($seconds%60))"
  else
    printf "printing time till `date -d $1`  \n\n"
    if [[ "$days" -ne 0 ]]; then
      echo "$days days "
    fi
    if [[ "$hours" -ne 0 ]]; then
      echo "$(($hours%24)) hours and "
    fi
    if [[ "$minutes" -ne 0 ]]; then
      echo "$(($minutes%60)) minutes and "
    fi
    echo "$(($seconds % 60)) seconds"
  fi
}
# simple calculator
function c() {
  noSpaceExpr=`echo $* | sed -e "s/ //g"`
  awk "BEGIN { print $noSpaceExpr }"
}

transfer() {
  if [ $# -eq 0 ];
  then
    echo "No arguments specified. Usage:\necho transfer /tmp/test.md\ncat /tmp/test.md | transfer test.md";
    return 1;
  fi
  tmpfile=$( mktemp -t transferXXX );
  if tty -s; then
    basefile=$(basename "$1" | sed -e 's/[^a-zA-Z0-9._-]/-/g');
    curl --progress-bar --upload-file "$1" "https://transfer.sh/$basefile" >> $tmpfile;
  else
    curl --progress-bar --upload-file "-" "https://transfer.sh/$1" >> $tmpfile ;
  fi;
  cat $tmpfile;
  rm -f $tmpfile;
}

cdown() {
  if [ $# -eq 0 ];
  then
    echo no arg specified
    echo "funciton <time in min> <beep freq in sec>"
    return 1
  fi
  date1=$((`date +%s` + $1*60));
  elapsed=0
  bells=0
  while [ "$date1" -ge $(date +%s) ]; do
    echo -ne "$(date -u --date @$(($date1 - $(date +%s) )) +%H:%M:%S)\b\b\b\b\b\b\b\b";
    sleep 1
    elapsed=$(( elapsed + 1))
    if [ "$elapsed" -eq $2 ]; then
      bells=$(( bells + 1))
      for i in $(seq 1 $bells);
      do
        paplay /usr/share/sounds/freedesktop/stereo/bell.oga
      done
      elapsed=0
    fi
  done
  paplay /usr/share/sounds/freedesktop/stereo/alarm-clock-elapsed.oga
}

timeGoogle() {
  sudo date -s "$(wget -S  "http://www.google.com/" 2>&1 | grep -E '^[[:space:]]*[dD]ate:' | sed 's/^[[:space:]]*[dD]ate:[[:space:]]*//' | head -1l | awk '{print $1, $3, $2,  $5 ,"GMT", $4 }' | sed 's/,//')"
}

# create a tmux for the first teminal spawned 
attach_to_tmux() {
  export TMUX_SOCKET_NAME=${1:-default}
  TMUX_SESSION_NAME=${2:-Main}
  if [ $(tmux -L $TMUX_SOCKET_NAME list-sessions 2> /dev/null | wc -l) -eq 0 ] ; then
    # if no tmux session in the machine , create  one and attach
    tmux -L $TMUX_SOCKET_NAME new-session -s "$TMUX_SESSION_NAME" -d ;
    tmux -L $TMUX_SOCKET_NAME attach;
  else
    # if a session is already there but not attached, then attach
    if [ $(tmux -L $TMUX_SOCKET_NAME list-clients | wc -l) -eq 0 ]; then
      tmux -L $TMUX_SOCKET_NAME attach;
    fi
    # else do nothing if alredy attached
  fi
  alias ta='tmux -L $TMUX_SOCKET_NAME attach'
  alias tad='tmux -L $TMUX_SOCKET_NAME attach -d'
}

list_custom_defined_functions() {
  #TODO
  if [[ $SHELL =~ "zsh" ]]; then
    # if zsh
    functions | grep -P "^[^_ \t][^ ]* *\(\)" | grep -vP "^(prompt_|is-)"
  else
    # if bash
    declare -F
  fi
}

# }}}

export VISUAL=/usr/bin/vim
export EDITOR=/usr/bin/vim
export BC_ENV_ARGS=~/.bcrc
export GOPATH=~/go
export PATH="$PATH:$GOPATH/bin:$HOME/.gem/ruby/2.4.0/bin:$HOME/bin"


decimal_to_binary() {
  export D2B=({0..1}{0..1}{0..1}{0..1}{0..1}{0..1}{0..1}{0..1})
  echo "${D2B[$1]}"
  # leading zeros removed
  echo $(( ${D2B[$1]} ))
}
binary_to_decimal() {
  echo $((2#$1))
}
